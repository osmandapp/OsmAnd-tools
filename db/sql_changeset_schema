# DDL for changeset database
# DDL
CREATE TABLE pending_changesets (id text, created_at text) ;
CREATE TABLE changesets (id text, bot int, created_at timestamp, closed_at timestamp, username text, closed_at_day text, uid text, created_by text, minlat float, minlon float, maxlat float, maxlon float, PRIMARY KEY(id));
CREATE TABLE countries(id int, parentid int, name text, fullname text, downloadname text, clat float, clon float,  map int, PRIMARY KEY(id));
CREATE TABLE changeset_country(changesetid text, countryid int, small int);
CREATE TABLE supporters(userid text, token text, visiblename text, useremail text, preferred_region text, disable int);

# mail group
CREATE TABLE map_users(aid text, email text, updatetime bigint);
CREATE TABLE email_blocked(email text, reason text, timestamp bigint);
CREATE TABLE email_unsubscribed(email text, channel text, updatetime bigint);
CREATE TABLE email_support_survey(ip text, response text, timestamp timestamp);

CREATE TABLE data_missing_search(ip text, search text, location text, timestamp timestamp);

CREATE TABLE osm_recipients(osmid text, email text, btcaddr text, updatetime bigint);
CREATE SEQUENCE supporters_seq START 1000;
ALTER TABLE supporters ADD PRIMARY KEY (userid);
CREATE TABLE supporters_subscription(userid text, sku text, purchasetoken text, checktime bigint,
			autorenewing text, starttime bigint, expiretime bigint, kind text);
CREATE TABLE supporters_device_sub(userid text, sku text, purchasetoken text, valid boolean, timestamp timestamp);

ALTER TABLE changeset_country OWNER TO <user>;

CREATE INDEX changesets_id_idx on changesets(id);
CREATE INDEX changesets_closed_at_day_idx on changesets(closed_at_day);
CREATE INDEX changesets_username_idx on changesets(username);
CREATE INDEX changesets_country_country_idx on changeset_country(countryid);
CREATE INDEX changesets_country_changeset_idx on changeset_country(changesetid);

CREATE TABLE final_reports (name text, month text, region text, report text, time int) ;

# CURRENT MONTH MATERIALIZED VIEW
CREATE MATERIALIZED VIEW changesets_view AS SELECT * FROM changesets where 
closed_at > ( (SELECT max(closed_at) FROM changesets)::date - '60 day'::interval) WITH DATA;
CREATE MATERIALIZED VIEW changeset_country_view AS SELECT * FROM changeset_country c where exists (select 1 from changesets_view d where d.id = c.changesetid) WITH DATA;
# REFRESH MATERIALIZED VIEW  changesets_view ;
# REFRESH MATERIALIZED VIEW  changeset_country_view ;

###### TELEGRAM SERVER MONITORING ########
CREATE TABLE telegram_monitoring (
  id bigint NOT NULL,
  first_name varchar(100)  DEFAULT NULL,
  last_name varchar(100)  DEFAULT NULL,
  user_id bigint DEFAULT NULL,
  data jsonb,
  PRIMARY KEY (id)
) ;

###### TELEGRAM TRACKER CONFIGURATION ########
CREATE TABLE telegram_devices (
    id bigint NOT NULL,
    chat_id bigint NOT NULL,
    created_date timestamp NOT NULL,
    modified_date timestamp,
    device_name character varying(200)  NOT NULL,
    ext_config  bigint,
    ext_id character varying(200),
    user_id bigint NOT NULL,
    data jsonb,
    PRIMARY KEY (id)
);
CREATE INDEX telegram_devices_idx on telegram_devices(user_id);

CREATE TABLE telegram_tracker_configuration (
    id bigint NOT NULL,
    chat_id bigint NOT NULL,
    created_date timestamp NOT NULL,
    modified_date timestamp,
    tracker_id character varying(200)  NOT NULL,
    tracker_name character varying(200)  NOT NULL,
    token character varying(200),
    user_id bigint NOT NULL,
    data jsonb,
    PRIMARY KEY (id)
);
CREATE INDEX telegram_tracker_configuration_user_idx on telegram_tracker_configuration(user_id);

CREATE SEQUENCE telegram_tracker_configuration_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;
ALTER TABLE ONLY telegram_tracker_configuration ALTER COLUMN id SET DEFAULT nextval('telegram_tracker_configuration_id_seq'::regclass);
ALTER SEQUENCE telegram_tracker_configuration_id_seq OWNED BY telegram_tracker_configuration.id;


GRANT ALL privileges ON ALL TABLES IN SCHEMA public to <user>;
GRANT ALL privileges ON supporters_seq to <user>;
GRANT ALL privileges ON telegram_tracker_configuration_id_seq to <user>;
